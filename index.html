<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>



html, body{
    box-sizing: border-box;
    margin: 0px;
    padding: 0px;
}

.areaCanvas{
    margin-top: 30px;
    margin-left: auto !important;
    margin-right: auto !important;
    /* width: calc((100vw - (100vw - 100%))*0.9); */
    height: 500px;
    width: 500px;
    background-color: lavender;
    border: 1px solid black;    
}

</style>

<script>

document.addEventListener('keydown', observadorTeclasDown, false)
document.addEventListener('keyup', observadorTeclasUp, false)
window.addEventListener('load', init, false);

var canvas;
var canvasContext;
var canvasWidth;
var canvasHeight;
var x = 0;
var possibleMoves = [];
var idleState1;
var idleState2;
var objs = [];
var estadoAtual = 0;
var estados = [[telaInicial], [startAnimation], [startAnimation, animate]];
var speedIteratorX = 0;
var speedIteratorY = 0;
var maxSpeedX = 2;
var maxSpeedY = 2;
var defaultCanvasWidth = 500;
var defaultCanvasHeight = 500;
var logicalMap = [];
var idleState1;
var idleState2;
var objetos;
var viewState;
var viewStateMajor;
var initialX = 250;
var initialY = 250;

objs = [idleState1, idleState2];
objetos = [{x: 250, y:50, width: 50, height: 50}, {x: 450, y:450, width: 20, height: 20}, {x: 150, y:350, width: 20, height: 20}];
mapCoords = [{x: 250, y: 250, width: 0, height: 0}];
translate = [{x: 0, y: 0}];
viewStateMajor = [viewState];

idleState1 = {
    x: 50,
    y: 50,
    width: 5,
    height: 5,
    directions: {
        "none" : 1, 
        "up" : 0, 
        "down" : 0, 
        "left": 0,
        "right": 0
    } 
}

idleState2 = {
    x: 250,
    y: 50,
    width: 50,
    height: 50,
    directions: {
        "none" : 1, 
        "up" : 0, 
        "down" : 0, 
        "left": 0,
        "right": 0
    }
}

viewState = {
    x: initialX,
    y: initialY,
    width: 0,
    height: 0,
    directions: {
        "none" : 1, 
        "up" : 0, 
        "down" : 0, 
        "left": 0,
        "right": 0
    }
}

//************************* Trecho de Movimentacao ***********************
const activeKeyNotifier = {
    "ArrowUp"       : ArrowUp,
    "ArrowDown"     : ArrowDown,
    "ArrowLeft"     : ArrowLeft,
    "ArrowRight"    : ArrowRight,
}

const deactiveKeyNotifier = {
    "ArrowUp"       : ArrowUpRelease,
    "ArrowDown"     : ArrowDownRelease,
    "ArrowLeft"     : ArrowLeftRelease,
    "ArrowRight"    : ArrowRightRelease,
}

const activeKeyViewNotifier = {
    "i"             : iKeyPress
}

const deactiveKeyViewNotifier = {
    "i"             : iKeyRelease
}

//lista de movimentos possiveis
const moves = {
    "up": moveUp,
    "down": moveDown,
    "left": moveLeft,
    "right": moveRight,
    "none" : moveIdle
}

const viewMoves = {
    "up": moveUp,
    "down": moveDown,
    "left": moveLeft,
    "right": moveRight,
    "none" : moveIdle
}


//obervadores e manipuladores de valores de entrada
function observadorTeclasDown(e){
    keysManipulator(e.key);
}

function observadorTeclasUp(e){
    keysReleaseManipulator(e.key);
}

function keysManipulator(key){
    console.log(key);
    activeKeyNotifier.hasOwnProperty(key) ? activeKeyNotifier[key](idleState1) : console.log("null") ;
    activeKeyViewNotifier.hasOwnProperty(key) ? activeKeyViewNotifier[key](viewState) : console.log("null") ;
}

function keysReleaseManipulator(key){
    console.log("Soltou " + key);
    deactiveKeyNotifier.hasOwnProperty(key) ? deactiveKeyNotifier[key](idleState1) : console.log("null") ;
    deactiveKeyViewNotifier.hasOwnProperty(key) ? deactiveKeyViewNotifier[key](viewState) : console.log("null") ;
}

//seta direcao e caso sim articula chama funcao de mover/fazer movimento
//manipuladores de direcao, no caso de haver direcao, a funcao de articulacao eh responsavel por ver quais direcoes
//foram escolhidsa e chama o metodo de execucao de movimento
// A logica de arrow up e down poderia ser melhor com uma lista de teclas pressionadas e soltas num dado intervalo
function ArrowUp(obj){ obj.directions["up"] = 1; }
function ArrowDown(obj){ obj.directions["down"] = 1; }
function ArrowLeft(obj){ obj.directions["left"] = 1; }
function ArrowRight(obj){ obj.directions["right"] = 1; }
function iKeyPress(obj){ obj.directions["up"] = 1; }

function ArrowUpRelease(obj){ obj.directions["up"] = 0; }
function ArrowDownRelease(obj){ obj.directions["down"] = 0; }
function ArrowLeftRelease(obj){ obj.directions["left"] = 0; }
function ArrowRightRelease(obj){ obj.directions["right"] = 0; }
function iKeyRelease(obj){ obj.directions["up"] = 0; }

function moveUp(obj){ obj.y = obj.y     +   speedIterator("y", -1);}
function moveDown(obj){ obj.y = obj.y   +   speedIterator("y", 1);}
function moveLeft(obj){obj.x = obj.x    +   speedIterator("x", -1);}
function moveRight(obj){obj.x = obj.x   +   speedIterator("x", 1);}
function moveIdle(obj){return;}

//deletar
function viewMoveUp(obj){ obj.y = obj.y     +   speedIterator("y", -1);}
function viewMoveDown(obj){ obj.y = obj.y   +   speedIterator("y", 1);}
function viewMoveLeft(obj){obj.x = obj.x    +   speedIterator("x", -1);}
function viewNoveRight(obj){obj.x = obj.x   +   speedIterator("x", 1);}
function viewMoveIdle(obj){return;}

function articulateMove(obj){

    for(let key in obj.directions){ 
        if(obj.directions[key] == 1){ moves[key](obj) } 
    }
}

//Metodo a ser inserido no loop central de animacao geral
function idlesLoop(objs){
    for(var i = 0; i < objs.length; i++) articulateMove(objs[i])
}

//Metodo a ser inserido no loop central de animacao geral
function viewLoop(obj){
    articulateMove(obj)
}

//speed iterator precisa ser melhorado
function speedIterator(axis, modulo){
    
    if(axis == "x"){
        if(Math.sign(speedIteratorX) == Math.sign(modulo)){
            if(  Math.abs((speedIteratorX + modulo)) < Math.abs(maxSpeedX) ){
                speedIteratorX = speedIteratorX + modulo;
            }
        }else{
            speedIteratorX = speedIteratorX*(-1);
            if(  Math.abs((speedIteratorX + modulo)) < Math.abs(maxSpeedX) ){
                speedIteratorX = speedIteratorX + modulo;
            }
        }
        return speedIteratorX;
    }

    if(axis == "y"){
        if(Math.sign(speedIteratorY) == Math.sign(modulo)){
            if(  Math.abs((speedIteratorY + modulo)) < Math.abs(maxSpeedY) ){
                speedIteratorY = speedIteratorY + modulo;
            }
        }else{
            speedIteratorY = speedIteratorY*(-1);
            if(  Math.abs((speedIteratorY + modulo)) < Math.abs(maxSpeedY) ){
                speedIteratorY = speedIteratorY + modulo;
            }
        }
        return speedIteratorY;
    }

    return 0;
}

//********************** End Movimentacao **********************

//************************ Vizualizacao ************************

function translateObjs(elementos){
    for(var i = 0; i < elementos.length; i++){
        elementos[i].x = elementos[i].x  -(viewState[0].x - initialX);
        elementos[i].y = elementos[i].y  -(viewState[0].y - initialY);
    }
}

//**************************************************************



//********************* Trecho de Animacao *********************
function drawSquare(obj){

    var x = obj.x;
    var y = obj.y;
    var width = obj.width;
    var height = obj.height;

    canvasContext.fillRect(x, y, width, height);
}


function drawMap(){
    
    translateObjs(objs);
    translateObjs(objetos);

    for(var i = 0; i < objetos.length; i++){
        drawSquare(objetos[i]);
    }
}
//********************* End Animacao *********************



//********************* Animacao Central *********************
//loop animacao - um apenas starta com algumas medidas e alocacaoes e a outra funcao q eh o loop em si


function initCanvas(){
    canvas = document.getElementById('canvas');
    canvasContext = canvas.getContext('2d');
    canvasWidth = canvas.width = defaultCanvasWidth;
    canvasHeight = canvas.height = defaultCanvasHeight;
    telaInicial();
}

function telaInicial(){

    ++estadoAtual;
    canvasContext.font = "30px Arial";
    canvasContext.fillStyle = "black";
    canvasContext.textAlign = "center";
    canvasContext.fillText("Click", canvas.width/2, canvas.height/2);
}

function startAnimation(){

    ++estadoAtual;

    initLogicalMap();

    animate();
}

function animate(){
    
    canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
    
    //logica de objetos como idles e npcs
    idlesLoop(objs);

    //desenho do elementos idles e npcs
    drawSquare(idleState1);
    
    //calcula logica de scenario
    //refreshLogicalMap();

    //desenhar o scenario logico
    drawMap();
    
    requestAnimationFrame(animate);
}

//******************* End Animacao Central *******************


//*************** Funcoes de proposito Geral *******************
function tryFunction(funcao){
    if( estados[estadoAtual].indexOf(funcao) > -1){
        funcao();
    }
}

function initCss(){
    //document.getElementById('canvas').style.
    document.getElementById('canvas').style.width = defaultCanvasWidth;
    document.getElementById('canvas').style.height = defaultCanvasHeight;
    //console.log(document.getElementById('canvas').style.width);
    document.getElementById('areaCanvas').style.width = defaultCanvasWidth + "px";
    document.getElementById('areaCanvas').style.height = defaultCanvasHeight + "px";
}

function insertLogicalSquare(objeto){
    var y1 = objeto.y;
    var y2 = objeto.y + objeto.height;
    var x1 = objeto.x;
    var x2 = objeto.x + objeto.width;
    for(var j = y1; j < y2; j++){
        for(var k = x1; k < x2; k++){
            logicalMap[j][k] = 1;
        }
    }
}

function initLogicalMap(){
    
    for(var i = 0; i < defaultCanvasHeight; i++){
        logicalMap[i] = [];
        for(var j = 0; j < defaultCanvasWidth; j++){
            logicalMap[i][j] = 0;
        }
    }

    for(var i = 0; i < objetos.length; i++){
        insertLogicalSquare(objetos[i]);
    }
    //drawMap();
}

function init(){
    
    initCss();
    initCanvas();
    //initLogicalMap();
}

function refreshLogicalMap(){
    return;
}

//********************* End Funcoes Geral **********************

</script>

<body>

    <div onclick="tryFunction(startAnimation)" class="areaCanvas" id="areaCanvas">
        
        <canvas id="canvas">
        </canvas>

    </div>
    <!-- <div align="center">
        <button onclick="moveUp(idleState1)">Up</button> | 
        <button onclick="moveDown(idleState1)">Down</button> |
        <button onclick="moveLeft(idleState1)">Left</button> |
        <button onclick="moveRight(idleState1)">Right</button>
    </div>
    <br>
    </body>
    <div id="dumpVar"></div> -->
    
</body>
</html>