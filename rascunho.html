<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>

/*Ok - limpando as laterais do navegador */
html, body{
    box-sizing: border-box;
    margin: 0px;
    padding: 0px;
}

/*Ok - centralizando a area onde fica o canvas*/
.areaCanvas{
    margin-top: 30px;
    margin-left: auto !important;
    margin-right: auto !important;
    /* width: calc((100vw - (100vw - 100%))*0.9); */
    height: 500px;
    width: 500px;
    background-color: lavender;
    border: 1px solid black;    
}

</style>












 

<script>

document.addEventListener('keydown', observadorTeclasDown, false)
document.addEventListener('keyup', observadorTeclasUp, false)
window.addEventListener('load', init, false);

var canvas;
var canvasContext;
var canvasWidth;
var canvasHeight;
var x = 0;
var idleState1;
var objs;
var defaultCanvasWidth = 500;
var defaultCanvasHeight = 200;
var dist = 1; 


//adicionados 
var idleImage;
var idleImage2;
var tempo = performance.now();
var nubFrameRate = 25;
var grounds = [];
var stageGround; 

idleState1 = {
    x: 0,
    y: 0,
    width: 100,
    height: 100,
    directions: {
        "none" : 1, 
        "up" : 0, 
        "down" : 0, 
        "left": 0,
        "right": 0,
        "Q" : 0
    }, 
    speed: 5,
    moveStates:{}
}

idleState2 = {
    x: 200,
    y: 100,
    width: 100,
    height: 100,
    directions: {
        "none" : 1, 
        "up" : 0, 
        "down" : 0, 
        "left": 0,
        "right": 0,
        "Q" : 0
    }, 
    speed: 5
}


groundables = [];

class idleState{

    constructor(obj){
        
        this.x = obj.x
        this.y = obj.y
        this.width = obj.width
        this.height = obj.height
        this.directions = {
            "none" : obj.directions.none, 
            "up" : obj.directions.up, 
            "down" : obj.directions.down, 
            "left": obj.directions.left,
            "right": obj.directions.right,
            "Q" : obj.directions.Q
        } 
        this.speed = obj.speed
    }
}






//movimentacao
const keyPressRelease = {
    "ArrowUp"       : up,
    "ArrowDown"     : down,
    "ArrowLeft"     : left,
    "ArrowRight"    : right,
    "Q"             : uping,
}

objs = [idleState1, idleState2];


var jogador = idleState1;
var externos = [idleState2];


function observadorTeclasDown(e){
    keysManipulator(e.key, "down");
}

function observadorTeclasUp(e){
    keysManipulator(e.key, "up");
}

function keysManipulator(key, upDown){
    
    if(keyPressRelease.hasOwnProperty(key)) {
        keyPressRelease[key](idleState1, upDown)
    }      
}

function up(obj, dir)   {
    if(dir == "down"){obj.directions.up = 1}
    if(dir == "up"){obj.directions.up = 0}
}
function down(obj, dir) {
    if(dir == "down"){obj.directions.down = 1}
    if(dir == "up"){obj.directions.down = 0}
}
function left(obj, dir) {
    if(dir == "down"){obj.directions.left= 1}
    if(dir == "up"){obj.directions.left = 0}
}
function right(obj, dir){
    if(dir == "down"){obj.directions.right = 1}
    if(dir == "up"){obj.directions.right = 0}
}

function uping(obj, dir){
    if(dir == "down"){obj.directions.Q = 1}
    if(dir == "up"){obj.directions.Q = 0}
}



function logics(objs){


    objs.forEach( elemento => {
        if(elemento.directions["up"] == 1){translate2dY(elemento, -elemento.speed)}
        if(elemento.directions["down"] == 1){translate2dY(elemento, elemento.speed)}
        if(elemento.directions["left"] == 1){translate2dX(elemento, -elemento.speed)}
        if(elemento.directions["right"] == 1){translate2dX(elemento, elemento.speed)}
        if(elemento.directions["Q"] == 1){upingMove(elemento, elemento.speed)}
    })

}

function translate2dX(elemento, dist){
    elemento.x = elemento.x  + dist;
    if( !checkCollideAllCirc(elemento, externos)) return 1;
    elemento.x = elemento.x - dist; 
} 

function translate2dY(elemento, dist){
    elemento.y = elemento.y  + dist;
    if( !checkCollideAllCirc(elemento, externos)) return 1;
    elemento.y = elemento.y - dist;
}


//cada movimento adicionado vai ser um obj
function upingMove(el, speed ){

  
    if(el.moveStates.hasOwnProperty("jumping")){
        
    }else{

    }
      
     
}










//animacao
function drawSquare(obj){

    var x = obj.x;
    var y = obj.y;
    var width = obj.width;
    var height = obj.height;

    canvasContext.fillRect(x, y, width, height);
}

//******************************************************************************************************************************

function drawImage(obj){
    //console.log(obj.idleState);
    canvasContext.drawImage(obj, obj.xA, obj.zA, obj.spriteWidth, obj.spriteHeight, obj.idleState.x , obj.idleState.y, obj.idleState.width, obj.idleState.height);
}

function drawImageInverted(obj){
    //console.log(obj.idleState);
    canvasContext.drawImage(obj, obj.xA, obj.zA, obj.spriteWidth, obj.spriteHeight, obj.idleState.x , obj.idleState.y, obj.idleState.width, obj.idleState.height);
}

//assume todos os sprites do mesmo tamanho, e faz isso para cada modelo2d, logo a instanciacao de cenarios fica para outro lugar  
function initLoadImageResources(idleState, imgId, spriteWidth, spriteHeight, animationStates, currentAnimationState){
    
    var obj = document.getElementById(imgId);
    obj.animationStates = animationStates;
    obj.currentAnimationState = currentAnimationState;
    
    obj.spriteWidth = spriteWidth;
    obj.spriteHeight = spriteHeight;

    obj = changeAnimationStateTo(obj, currentAnimationState)

    obj.idleState = idleState
    
    return obj;
}

//muda o estado total com base em action (anda, pula, rola), e actionstate (anda sprite 1, anda sprite 2)
function changeAnimationStateTo(obj, currentAnimationState){
    
    obj.currentAnimationState = currentAnimationState;
    obj.zA =  obj.animationStates[currentAnimationState.action].position * obj.spriteHeight;//cada acao eh uma linha, assumindo sprites de tamanhos iguais 
    obj.xA =  currentAnimationState.actionState * obj.spriteWidth;      
    obj.zB = obj.zA + obj.spriteHeight;
    obj.xB = obj.xA + obj.spriteWidth;
    
    return obj;
}

//refatorar pois nao precisa do segundo argumento que a priori eh justamente algo q o obj ja tem
function incrementAnimationActionState(obj, currentAnimationState){

    obj.currentAnimationState.actionState = (currentAnimationState.actionState + 1) % (obj.animationStates[currentAnimationState.action].maxStates);
    return changeAnimationStateTo(obj, obj.currentAnimationState);
}
















//colisao
function checkCollide(obj, alvo){    
    var raioA = raioMenor(obj.width, obj.height);
    var raioB = raioMenor(alvo.width, alvo.height);
    var distancia = distanciaAB(obj.x + obj.width/2, alvo.x + alvo.width/2, obj.y + obj.height/2, alvo.y +alvo.height/2 )
    console.log(raioA + " " + raioB + " " + distancia);
    if(raioA + raioB >= distancia) return 1;
}

//parei aqui
function checkCollideGround(obj, alvo){    
    
}

function checkCollideAllCirc(obj, objs){
    
    for( var i = 0; i < objs.length; i++ ){
        if(checkCollide(obj, objs[i])) return 1;
    }
    
} 

function checkCollideAllGrounds(obj, objs){
    
    for( var i = 0; i < objs.length; i++ ){
        if(checkCollideGround(obj, objs[i])) return 1;
    }    
}


function raio(x, y){
    return ( ( (x/2.0)**2 + (y/2.0)**2 )**(0.5) );
}

function raioMenor(altura, largura){
    return altura/2;
}

function distanciaAB( x1, x2, y1, y2){
    return (  ((x2 - x1)**2 + (y2 - y1)**2)**(0.5)  );
}















//init
function initCanvas(){
    canvas = document.getElementById('canvas');
    canvasContext = canvas.getContext('2d');
    canvasWidth = canvas.width = defaultCanvasWidth;
    canvasHeight = canvas.height = defaultCanvasHeight;
    //telaInicial();
    //animate();
}

function initCss(){
    //document.getElementById('canvas').style.
    document.getElementById('canvas').style.width = defaultCanvasWidth;
    document.getElementById('canvas').style.height = defaultCanvasHeight;
    //console.log(document.getElementById('canvas').style.width);
    document.getElementById('areaCanvas').style.width = defaultCanvasWidth + "px";
    document.getElementById('areaCanvas').style.height = defaultCanvasHeight + "px";
}

function init(){
    
    initCss();
    initCanvas();


    //adicionado
    var states = [];
    //remover pois isso eh da instanciacao de cada modelo2d
    states["idle"] = {position:0, maxStates:7};
    states["stunned"] = {position:4, maxStates:9};
    states["rolling"] = {position:6, maxStates:7};
    idleImage = initLoadImageResources( idleState1,"idleImageId", 575, 523, states, {action: "idle", actionState:0});
    idleImage2 = initLoadImageResources( idleState2, "idleImageId2", 575, 523, states, {action: "idle", actionState:0}  )
    
    idleImage.idleState.x = 0;
    idleImage.idleState.y = defaultCanvasHeight * 0.7 - idleImage.idleState.height;

    idleImage2.idleState.x = defaultCanvasWidth - idleImage2.idleState.width;
    idleImage2.idleState.y = defaultCanvasHeight * 0.7 - idleImage.idleState.height;

    stageGround = new idleState(idleState1);
    stageGround.x = 0;
    stageGround.y = canvasHeight * 0.7;
    stageGround.width = canvasWidth;
    stageGround.height = canvasHeight * 0.3;
    groundables.push(stageGround);

    
    animate();
}

















function animate(){
    
    canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
    
    logics([idleImage.idleState]);//logica de mov

    var diff = performance.now() - tempo;
    if( (diff) > nubFrameRate){
        tempo = performance.now();
    }
    //adicionado
    drawSquare(stageGround)
    drawImage(idleImage);
    //drawSquare(idleState2);
    drawImage(idleImage2);
    //drawSquare({x: 0, y: canvas.height * 0.7, width: canvas.width, height: canvas.height * 0.3});
    diff > nubFrameRate ? idleImage = incrementAnimationActionState(idleImage, idleImage.currentAnimationState) : 1 == 1;
    diff > nubFrameRate ? idleImage2 = incrementAnimationActionState(idleImage2, idleImage2.currentAnimationState) : 1 == 1;
    
    requestAnimationFrame(animate);
}









</script>


<body>

    <img id="idleImageId" src="assets/idleImage.png" style="display:none;">
    <img id="idleImageId2" src="assets/idleImage.png" style="display:none;">

    <div onclick="" class="areaCanvas" id="areaCanvas">
        
        <canvas id="canvas">
        </canvas>

    </div>
    
</body>
</html>